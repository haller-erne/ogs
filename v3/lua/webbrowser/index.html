<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://haller-erne.github.io/ogs/v3/lua/webbrowser/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Web browsers - OGS Documentation</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Browser", url: "#_top", children: [
              {title: "Overview", url: "#overview" },
              {title: "JavaScript hostObjects bridge", url: "#javascript-hostobjects-bridge" },
              {title: "Global Browser table", url: "#global-browser-table" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../webserver/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../webserver/" class="btn btn-xs btn-link">
        Webserver (and REST API)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../getting-started/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../getting-started/" class="btn btn-xs btn-link">
        Getting Started
      </a>
    </div>
    
  </div>

    

    <h1 id="browser">Browser</h1>
<h2 id="overview">Overview</h2>
<p>The OGS runtime uses up to 4 web browser (Microsoft WebView2) instances. The instances are:
- <code>StartView</code>: Browser on the start screen
- <code>ProcessView</code>: Browser on the process screen (only visible, if the <code>url</code>-parameter in the job/task is set)
- <code>SidePanel</code>: Browser on the slide-in side panel (requires enabling the sidepanel in <code>station.ini</code>)
- <code>InstructionView</code>: Browser in the instruction view popup (is triggered from LUA, so only visible with custom LUA code)</p>
<p>The OGS infrastructure provides functions to bidirectionally exchange data between the JavaScript code running inside the web browser and the LUA code running inside OGS. There is a LUA function to execute JavaScript code in the webbrowser and a JavaScript bride, which calls a LUA function (if registered accordingly).</p>
<p>To implement this functionality, OGS provides the following:
- For the JavaScript side: a bridge implementation accessibal through the <code>hostObjects</code> interface of the Chromium browser (<code>window.chrome.webview.hostObjects.sync.OGS</code>)
- For the LUA side: a global <code>Browser</code> table with functions to manipulate the browser instances</p>
<h2 id="javascript-hostobjects-bridge">JavaScript hostObjects bridge</h2>
<p>OGS registers a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.web.webview2.core.corewebview2.addhostobjecttoscript">hostObject</a> in the WebView2 browser for the JavaScript side. The registered object is named <code>OGS</code> and implements a single string property <code>ObjectMessage</code>.</p>
<p>To send a string to OGS from JavaScript, simply assign a value to the <code>window.chrome.webview.hostObjects.sync.OGS.ObjectMessage</code> property.</p>
<h4 id="sample-code">Sample code</h4>
<pre><code class="language-javascript">// send a command string to OGS 
function sendOgsCommand(cmd)
{
    if (!window.chrome || !window.chrome.webview
     || !window.chrome.webview.hostObjects
     || !window.chrome.webview.hostObjects.sync) {
        // WebView2 is not yet fully initialized
        return;     
    }
    let ogs = window.chrome.webview.hostObjects.sync.OGS;
    if (ogs) {
        ogs.ObjectMessage = cmd;    
    }
}
</code></pre>
<h2 id="global-browser-table">Global Browser table</h2>
<p>OGS exposes the browser instances through the global <code>Browser</code> object. The <code>Browser</code> object implements the following functions:</p>
<ul>
<li><a href="#navigate">Navigate</a>: Load a new URL in the web browser</li>
<li><a href="#execjs-nonblocking">ExecJS_nonblocking</a>: Run javascript inside the web browser (asynchronously, not returning a value)</li>
<li><a href="#reg.msg-handler">RegMsgHandler</a>: Register a LUA callback function to be called when the JavaScript side writes to the object message endpoint.</li>
</ul>
<!--
The following functions are also available, but are not fully implemented at the moment:
- [ExecJS_sync](#execjs-sync): 
- [ExecJS_async](#execjs-async):
- [Show](#show): 
- [Hide](#hide): 
- [GetState](#getstate): 
-->

<h3 id="navigate">Navigate</h3>
<p>The <code>Browser.Navigate</code> function starts loading a new URL into the given browser instance.</p>
<pre><code class="language-LUA">Browser.Navigate(instance, url)
</code></pre>
<h4 id="parameters">Parameters</h4>
<ul>
<li>instance [string]: Web browser instance name (one of 'StartView', 'ProcessView', 'SidePanel', 'InstructionView') </li>
<li>url [string]: Url to navigate the browser instance to (in the standard URL format, e.g. file://filename or https://server/page)</li>
</ul>
<h4 id="sample-code_1">Sample code</h4>
<pre><code class="language-LUA">-- Navigate the StartView browser to https://www.my-url.com/mypage
Browser.Navigate('StartView', 'https://www.my-url.com/mypage')
</code></pre>
<h3 id="regmsghandler">RegMsgHandler</h3>
<p>The <code>Browser.RegMsgHandler</code> function registers or unregisters a LUA function to be called whenever the JavaScript running in the browser writes a message to the hostObject bridge <code>OGS.ObjectMessage</code> property.</p>
<pre><code class="language-LUA">-- Register the callback function
fn, err = Browser.RegMsgHandler(instance, callbackfn)
</code></pre>
<h4 id="parameters_1">Parameters</h4>
<ul>
<li>instance [string]: Web browser instance name (one of 'StartView', 'ProcessView', 'SidePanel', 'InstructionView') </li>
<li>callbackfn [function]: LUA function to be called when the JavaScript code writes a string to the <code>OGS.ObjectMessage</code> hostObject. If callbackfn is <code>nil</code>, then the current registration is removed. The callback function has the following signature:<pre><code>callbackfn(instance, objectMessage)
</code></pre>
</li>
</ul>
<p>Where instance [string] is the web browsers instance name (e.g. 'StartView') and objectMessage [string] the text which was written to the <code>OGS.ObjectMessage</code> property of the hostObject bridge from the JavaScript side.</p>
<h4 id="return-values">Return values</h4>
<p>If the function was executed successfully, the callbackfn is returned as the first return value. Else nil is returned and the second return value has an error message string (wrong parameters or unknown instance).</p>
<h4 id="sample-code_2">Sample code</h4>
<pre><code class="language-LUA">local function callbackfn(instance, objectMessage)
    -- do whatever you want to do here if the javascript 
    -- code writes the OGS.ObjectMessage property
end

-- Register a LUA function to be called from the JavaScript side
Browser.RegMsgHandler('StartView', callbackfn)
</code></pre>
<h3 id="execjs_nonblocking">ExecJS_nonblocking</h3>
<p>The <code>Browser.ExecJS_nonblocking</code> executes JavaScript code in the web browser instance.</p>
<pre><code class="language-LUA">Browser.ExecJS_nonblocking(instance, jstext)
</code></pre>
<h4 id="parameters_2">Parameters</h4>
<ul>
<li>instance [string]: Web browser instance name (one of 'StartView', 'ProcessView', 'SidePanel', 'InstructionView') </li>
<li>jstext [string]: JavaScript string to execute in the browser. Note that this must be valid JavaScript code. </li>
</ul>
<p><strong>NOTES</strong>: </p>
<ul>
<li>When passing strings through the function, make sure to propery escape them!</li>
<li>Best practice is to write a JavaScript function in the web page and only call it through this function.</li>
<li>You can serialize LUA objects to a JSON string and pass this through the function. The JavaScript side can then easily deserialize it.</li>
</ul>
<h4 id="sample-code_3">Sample code</h4>
<pre><code class="language-LUA">-- Build a JavaScript command, call the function &quot;my_function&quot; with
-- some JSON text
local param = '{ &quot;cmd&quot;: &quot;showmessage&quot; }'
local command = &quot;my_function(&quot;..param..&quot;);&quot;
-- Call the JavaScript function in the StartView browser
Browser.ExecJS_nonblocking('StartView', command)
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../webserver/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../webserver/" class="btn btn-xs btn-link">
        Webserver (and REST API)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../getting-started/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../getting-started/" class="btn btn-xs btn-link">
        Getting Started
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>