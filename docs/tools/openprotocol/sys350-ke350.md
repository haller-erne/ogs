

# (DRAFT) KE350 MultiSpindle controller

## Loosen modes

System350 based tools mainly fall into two categories:

- Single spindle tools and ErgoSpin tools used in spindle mode
- Multi-spindle tools
- ErgoSpin tools (used in ErgoSpin hand-tool mode) - these are not considered here, as typically a CS351 controller is used in this case.

Spindle tools (and ErgoSpin in spindle mode) use externally connected start switches (for start CW, start CCW), whereas ErgoSpins in hand-tool mode use the built-in direction selector switch and start switch. All tools are controlled over OpenProtocol using the "Ford OpenProtocol" protocol type and are started in application mode (using fasterning operation FO 1).

Additional notes:

- Check the PSet parameter setting "play with start switch"
- Check the `CHANNEL_<tool>_CCW_ACK` setting for the tool in `station.ini`.

For the `CHANNEL_<tool>_CCW_ACK` setting, the following is recommended:

- If you use an ErgoSpon tool, then use `CHANNEL_<tool>_CCW_ACK=1` to enforce changing the direction switch on the ErgoSpin according to tighten/loosen.
- If you use a spindle tool with seperately wired CW/CCW and start signals, then set `CHANNEL_<tool>_CCW_ACK=1`
- If you use a spindle tool with CW start and CCW start signals, then set `CHANNEL_<tool>_CCW_ACK=0`

!!! note

    To reliably prevent loosen it is recommended to use a seperate direction switch connected to the CcwSel signal and a start switch connected to FO 1 Cw.

## OpenProtocol configuration

### Overview

OGS uses the KE350 `Rexroth OP-Ford R1.0` protocol version. This maps the
OpenProtool commands to the application start (fastening operation) `FO 1` signals, so multiple spindles can work in a synchronized way and report the
spindle groups result status. 

![KE350 OpenProtocol settings](resources/ke350-openprotocol-settings.png){ align=right; width=300 }
/// caption
KE350 OpenProtocol settings
///

### PLC signal assinment for OpenProtocol

The PLC signals relevant for OGS are as follows:

| Inputs            |   | Signal        | Assignment | Comments |
| ---               | - | ----          | ----      | ---- |
| OP0.1-OP0.7 @span |   | FO 1 Seq0-7   | Mandatory | Application number, *must* be assigned |
| OP1.0 @span       |   | FO 1 Enabled  | Optional  | True, if the application was enabled by OGS |
| OP1.1-3.0 @span   |   | Custom I/O    | See below | Signals controlled by OGS | 
|       | OP1.1         | FO 1 CCWLock | Optional  | The signal is set by OGS whenever a normal tightening process is expected to run - it is released, if loosening/rework is active instead. If assigned to `FO 1 CCWLock`, this effectively prevents a CCW-Start if OGS expectes a CW-Start (prevent unauthorized loosen). Note, that a user with right `lossen by CCW` always is allowed to loosen, i.e. this signal is then always set to false! |
| OP3.1-5.0 @span   |   | unused        | | | 
| OP5.1 @span       |   | FO 1 Disable  | Mandatory | This signal enables/disables the tool | 



### Single channel tool

The signals used in this scenario are:

- CW
- CCW
- CcwSel
- CwLock, CcwLock
- CwAnd, CcwAnd

### Multi channel tool

For multi-spindle tools, the following PLC assignment table is used:

![KE350 PLC assignment table](resources/ke350-openprotocol-plc-table.png){ width=300 }

Note that the tool is started through the external start signals `FO 1 Cw` or `FO 1 Ccw`. 
